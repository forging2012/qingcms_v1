 var dos=window.dos ||{ switchPic:function(obj,path,name,action){ if(action=='close'){ $(obj).parent('.pic_big').prev('.pic').show(); $(obj).parent('.pic_big').hide(); return false; } var bigImg=$(obj).parent('.pic').next('.pic_big').children('img'); if(bigImg.attr('src')==''){ bigImg.attr('src',PIC+'/'+path+'/m_'+name); } $(obj).parent('.pic').next('.pic_big').show(); $(obj).parent('.pic').hide(); } };  var vote=window.vote ||{  add:function(id,type,num,uid){ if( !(vote.check(uid)) ){ return false;} $.getJSON(APP+'/Public/vote/',{id:id,type:type},function(txt){ if(txt['success']>0){ vote.success(id,type,num); }else{ ui.error(txt['msg']); } }); },  check:function(uid){ if(MID<=0){ ui.error('请先登录'); return false; } if(MID==uid){ ui.error('不能给自己投票'); return false; } return true; },  success:function(id,type,num){ $('#down_'+id).removeAttr('onclick').addClass('isvoted'); $('#up_'+id).removeAttr('onclick').addClass('isvoted'); if(type==1){ $('#up_'+id).append("<span id='addvote' style='position: absolute;z-index:1000;top:-10px;left:40px;font-size:12px;'>+1</span>"); $("#addvote").animate({fontSize:"30px"},'fast').fadeOut('fast',function(){$('#up_'+id).html(num+1).attr('class','isvoted barbox uped');}); }else{ $('#down_'+id).append("<span id='addvote' style='position: absolute;z-index:1000;top:-10px;left:40px;font-size:12px;'>+1</span>"); $("#addvote").animate({fontSize:"30px"},'fast').fadeOut('fast',function(){$('#down_'+id).html('-'+(num+1)).attr('class','isvoted barbox downed');}); } } };  var message=window.message ||{ show:function(){ $.getJSON(APP+'/Public/getMsg',function(txt){ var list = { comment:{url:APP+"/User/comment",name:"条新评论"}, notify:{url:APP+"/User/message",name:"条新通知"} }; if(txt.total!="0"){ var html2=''; for(var one in list){ if(txt[one] != undefined && parseInt(txt[one]) >0){ html2+="<li><a href='"+list[one].url+"'>"+txt[one]+list[one].name+"</a></li>"; } } $(".message_list").html(html2); $('.message_bar').fadeIn(); }else{$('.message_bar').hide();} }); }, close:function(obj){ $('.message_bar').fadeOut(); } };  var comment=window.comment ||{  checkLenRes:1,  del:function(id,tid){ $.post(APP+'/Public/delComment',{id:id,tid:tid},function(txt){ if(txt>0){ $('.comment_li_'+id).slideUp(); }else{ui.error('删除失败');} }); },  show:function(id,uid,comment){ if(id=='' || uid=='' ){ui.error('数据错误');return false;} var obj = $("#comment_list_"+id); if(obj.html()==''){ $('.comment_list').each(function(){ if( $(this).html()!='' ){ $(this).slideUp('fast').html(''); } }); obj.before('<div class="loading"></div>'); $.post(APP+'/Public/comment',{tid:id,uid:uid,comment:comment},function(txt){ if(txt){ obj.html(txt); obj.slideDown('normal',function(){$('.loading').slideUp(function(){$(this).remove();});}); }else{ $('.loading').slideUp(); ui.error('获取评论失败'); } }); }else{ obj.slideUp('normal',function(){obj.html('');}); } },  add:function(id,type){ if( !(comment.check()) ){ return false;} $('.comment_submit_'+id).val('发表中...'); var options = { dataType:'json', success: function(txt) { if(txt['success']){ if(type=='detail'){ ui.success('发布成功'); setTimeout('location.reload()',600); }else if(type='ajax'){ comment.reload(id); } }else{ ui.error(txt['msg']); $('.comment_submit_'+id).val('发表'); } } }; $('#commentForm').ajaxSubmit(options); },  check:function(){ if(MID<=0){ ui.error('请先登录'); return false; } if($('.comment_ta').val()==''){ ui.error('请输入内容'); return false; } if(comment.checkLenRes==0){ui.error('输入内容过短');return false; } if(comment.checkLenRes==2){ui.error('输入内容过长');return false; } return true; },  checkLen:function(){ var obj=$('#comment_ta'); obj.keyup(function(){ var len=getLength(obj.val()); if(len<minComLen){ comment.checkLenRes=0; $('.comLen_span').html('至少还需要输入<strong style="color:blue;" id="comLen">'+(minComLen-len)+'</strong>字'); }else if(len<=comLen){ comment.checkLenRes=1; $('.comLen_span').html('你还可以输入<strong id="comLen">'+(comLen-len)+'</strong>字'); }else if(len>comLen){ comment.checkLenRes=2; $('.comLen_span').html('已超过<strong style="color:red;" id="comLen">'+(len-comLen)+'</strong>字'); } }); },  reload:function(tid){ var obj=$('#comment_'+tid); var uid=obj.attr('tuid'); var comment=obj.attr('tcomment'); comment=parseInt(comment)+1; obj.attr('tcomment',comment); obj.html(comment); if(tid=='' || uid=='' ){ui.error('数据错误');return false;} var obj = $("#comment_list_"+tid); $.post(APP+'/Public/comment',{tid:tid,uid:uid,comment:comment},function(txt){ if(txt){ obj.html(txt); } }); },  reply:function(id,type){ if(MID<=0){ ui.error('请先登录'); return false; } var type='noload'; var data=new Array(); data[0]=id; data[1]=type; ui.load('回复评论',APP+'/Public/replycomment',data); },  doreply:function(type){ var r_reply_comment_id=$('input[name="r_reply_comment_id"]').val(); var r_content=$('textarea[name="r_content"]').val(); var url=$('#repley_comment_form').attr('action'); $.post(url,{r_reply_comment_id:r_reply_comment_id,r_content:r_content},function(txt){ txt = eval("(" + txt + ")"); if(txt['success']>0){ ui.success('回复成功'); $('.ui_load').remove(); }else{ ui.error(txt['msg']); } }); },  init:function(){ comment.checkLen(); $('.comment_block').mouseover(function(){ $(this).find('.report').show(); }); $('.comment_block').mouseout(function(){ $(this).find('.report').hide(); }); },  report:function(id){ if(MID<=0){ ui.error('请先登录'); return false; } var data=id; ui.load('确定举报此评论？',APP+'/Public/report',data); }, doreport:function(obj){ var str=$(obj).serialize(); var action=$(obj).attr('action'); $.post(action,{data:str},function(txt){ if(txt>0){ ui.load_close(); ui.success('发送成功'); }else{ui.error('发送失败'); } }); } };  var publish=window.publish || {  checkLenRes:1,  ajaxSubmit:function(){ var options = { dataType:'json', type:'POST', success: function(txt) { if(txt['success']>0){ ui.success('恭喜，发布成功'); setTimeout('reurl('+txt['tid']+')',500); }else{ ui.error(txt['msg']); publish.reable(); } } }; if( !(publish.check()) ) return false; $('input[type="submit"]').val('发表中...').attr('disabled','disabled'); $('.Pub').append('<div class="loading"></div>'); $('#pubForm').ajaxSubmit(options); return false; },  reable:function(){ $('input,select,textarea').removeAttr('disabled'); $('input[type="submit"]').val('发表'); $('.loading').remove(); },  check:function(){ if($('.pub_area').val()==''){ui.error('内容不能为空');return false;} if(publish.checkLenRes==0){ui.error('输入内容过短');return false; } if(publish.checkLenRes==2){ui.error('输入内容过长');return false; } if($('select').val()==0 && cateMust==1){ui.error('分类必填');return false;} return true; },  checkLen:function(){ var obj=$('.pub_area'); obj.keyup(function(){ var len=getLength(obj.val()); if(len<minlength){ publish.checkLenRes=0; $('.length_span').html('至少还需要输入<strong style="color:blue;" id="length">'+(minlength-len)+'</strong>字'); }else if(len<=length){ publish.checkLenRes=1; $('.length_span').html('你还可以输入<strong id="length">'+(length-len)+'</strong>字'); }else if(len>length){ publish.checkLenRes=2; $('.length_span').html('已超过<strong style="color:red;" id="length">'+(len-length)+'</strong>字'); } }); } };  var tag=window.tag ||{ check:function(){ $("#tag_input").change(function(){ var t=$(this).val(); t=tag.dt(t); $.post(APP+"/Pub/ajaxCheckTag",{'tag':t},function(txt){ $('.tag_pre_list').html(txt); }); }); }, dt:function(tag){ var arrTag= tag.split(','); var newTag = ''; for(key in arrTag){ newTag = newTag+arrTag[key].replace(/(^\s*)|(\s*$)/g,"") + ','; } var r=newTag.slice(0,-1); return r; } };  function reurl(tid){ window.location.href=APP+"/Index/detail/id/"+tid; }  var loadmore={ check:function(){ var bodyTop = document.documentElement.scrollTop + document.body.scrollTop; if(bodyTop+$(window).height() >= $(document.body).height()){ loadmore.load(); } }, load:function(){ var obj=$('#loadMore'); var lastId=obj.attr('lastId'); obj.html('加载中...'); $.post(APP+'/User/loadmore',{lastId:lastId},function(txt2){ var txt=eval("("+txt2+")"); if(txt['success']>0){ $('.doingBox').append(txt['list']); obj.attr('lastId',txt['lastId']); obj.html('<span class="ico_loadmore"></span>更多'); }else{ obj.html('没有更多内容了...'); } }); }, init:function(){ $(document).ready(function(){ $(window).bind('scroll resize', function(e){ loadmore.check(); }); }); } };  var area={ show:function(){ $.post(APP+'/Public/showArea',function(txt){ var obj=$("#editarea"); $(obj).html('取消'); $(obj).attr('onclick','area.cancel();'); $('.location').html(txt).slideDown(); }); }, init:function(){ $(document).ready(function(){ $('#area_province').change(function(){ var province=$('#area_province').val(); $('#area_city').remove(); $.post(APP+'/Public/getCity',{province:province},function(txt){ $('#area_province').after(txt); }); }); }); }, cancel:function(){ var obj=$("#editarea"); $('.location').slideUp(function(){$(this).html('');}); $(obj).html('修改'); $(obj).attr('onclick','area.show();'); } };  var account={ init:function(){ $(document).ready(function(){ $('.account h3').click(function(){ var obj=$(this); var m_box=obj.next('.m-box'); var dis=obj.attr('class'); if(dis=='' || dis==undefined){ obj.addClass('hover'); m_box.slideDown(); }else{ m_box.slideUp(function(){ obj.removeClass('hover'); }); } }); $('form').submit(function(){ var str=$(this).serialize(); var action=$(this).attr('action'); $.post(action,{data:str},function(txt){ txt=eval("("+txt+")"); if(txt['success']){ ui.success(txt['msg']); }else{ ui.error(txt['msg']); } }); return false; }); $('input').focus(function(){ $(this).addClass("text_focus"); }).blur(function(){ $(this).removeClass("text_focus"); }); }); } };  function delText(id){ $.post(U('Ajax/delText'),{id:id},function(txt){ if(txt>0){ $('.text_list_'+id).slideUp(function(){$(this).next('.shadow').hide(); ui.success('删除成功'); }); }else{ui.error('删除失败'); } }); }  var follow={  add:function(fid,obj){ $.post(U('Ajax/addfollow'),{fid:fid},function(txt){ if(txt>0){ follow.reload(fid,obj); }else{ ui.error('关注失败'); } }); },  cancel:function(fid,obj){ $.post(U('Ajax/cancelFollow'),{fid:fid},function(txt){ if(txt>0){ follow.reload(fid,obj); }else{ ui.error('取消失败'); } }); },  reload:function(fid,obj){ $.post(U('Ajax/getRelation'),{fid:fid},function(txt){ $(obj).parent('.followBox').html(txt); }); } };  var group={  del:function(gid){ $.post(U('Ajax/delGroup'),{gid:gid},function(txt){ if(txt>0){ window.location.href=U('Space/following'); } }); }, html:function(action,value){ if(action==undefined) action="group.doadd();"; if(value==undefined) value=""; var html="<div class='addGroup'>"; html+="<div>"; html+="名称：<input name='name' type='text' value='"+value+"' class='text' id='addGroupInput'/>"; html+="</div>"; html+="<div class='b'>"; html+="<input type='button' class='btn' value='确定' onclick='"+action+"'/>"; html+="<input type='button' class='btn_w' value='取消' onclick='ui.load_close();'/>"; html+="</div>"; html+="</div>"; return html; },  add:function(){ var html=group.html(); ui.load('添加分组','','',html); }, doadd:function(){ var name=$('#addGroupInput').val(); $.post(U('Ajax/addGroup'),{name:name},function(txt){ if(txt){ window.location.href=U('Space/following')+'&gid='+txt; } }); },  edit:function(gid){ var name=$('.groupid_'+gid).html(); var html=group.html('group.doedit('+gid+');',name); ui.load('修改分组','','',html); }, doedit:function(gid){ var name=$('#addGroupInput').val(); $.post(U('Ajax/editGroup'),{name:name,gid:gid},function(txt){ if(txt){ window.location.href=U('Space/following'); } }); },  set:function(fid){ ui.load('修改分组',U('Ajax/setGroup'),fid); }, doset:function(obj){ var str=$(obj).serialize(); var action=$(obj).attr('action'); $.post(action,{data:str},function(txt){ if(txt){ ui.load_close(); ui.success('更新成功'); }else{ ui.error('更新失败'); } }); } };  function L(){ }  function U(url){ url = url.split('/'); if(url[0]=='') return false; if(url[1]==undefined || url[1]=='') url[1]='index'; url= APP+'?a='+url[1]+'&m='+url[0]; return url; }  var getLength = function(str, shortUrl) { if (true == shortUrl) { return Math.ceil(str.replace(/((news|telnet|nttp|file|http|ftp|https):\/\/){1}(([-A-Za-z0-9]+(\.[-A-Za-z0-9]+)*(\.[-A-Za-z]{2,5}))|([0-9]{1,3}(\.[0-9]{1,3}){3}))(:[0-9]*)?(\/[-A-Za-z0-9_\$\.\+\!\*\(\),;:@&=\?\/~\#\%]*)*/ig, 'xxxxxxxxxxxxxxxxxxxx') .replace(/^\s+|\s+$/ig,'').replace(/[^\x00-\xff]/ig,'xx').length/2); } else { return Math.ceil(str.replace(/^\s+|\s+$/ig,'').replace(/[^\x00-\xff]/ig,'xx').length/2); } }; var pub={}; jQuery.extend(pub, { video:function(element, options){ } }); jQuery.extend(pub.video, { type:'新浪播客、优酷网、土豆网、酷6网、搜狐', html:function(){ var html= '<div id="video_input">'+ '<div><input name="publish_type_data" type="text" style="width: 320px;margin-right:10px;" class="text" value="" />'+ '<input type="button" class="btn_2" style="padding:4px 10px;" onclick="pub.video.add_video()" value="添加"></div>'+ '<div>请输入视频播放页链接：支持'+pub.video.type+'网站 </div></div>'+ '<input type=\'hidden\' name=\'video_data\' value="">'+ '<div style="display:none" id="video_add_complete">添加完成</div>'; return html; }, init:function(obj){ $(obj).html(this.html()); }, add_video:function(){ var video_url = $("input[name='publish_type_data']").val(); if(!video_url){ui.error('请输入视频播放地址');return false;} $.post(APP+"/Pub/parse_videoUrl",{url:video_url},function(txt){ txt = eval('('+txt+')'); if(txt.boolen){ $('#video_input').hide(); $('#video_add_complete').show(); $("input[name='video_data']").val(txt.info); $("textarea[name=content]").val( $("textarea[name=content]").val( ) + ' ' + txt.content + ' ').keyup(); }else{ ui.error("只支持"+pub.video.type); } }); } }); function switchVideo(obj,host,flashvar,type){ if(type=='close'){ $(obj).parents(".video_show").hide(); $(obj).parents(".video_show").prev(".video_pic").show(); }else{ $(obj).parents(".video_pic").hide(); var show=$(obj).parents(".video_pic").next(".video_show"); show.children(".show_box").children(".show_obj").html(showFlash(host,flashvar)); show.show(); } } function showFlash( host, flashvar) { var flashAddr = { 'youku.com' : 'http://player.youku.com/player.php/sid/FLASHVAR/v.swf', 'ku6.com' : 'http://player.ku6.com/refer/FLASHVAR/v.swf', 'sina.com.cn' : 'http://you.video.sina.com.cn/api/sinawebApi/outplayrefer.php/vid=FLASHVAR/s.swf', 'tudou.com' : 'http://www.tudou.com/v/FLASHVAR/&autoPlay=true/v.swf', 'youtube.com' : 'http://www.youtube.com/v/FLASHVAR', '5show.com' : 'http://www.5show.com/swf/5show_player.swf?flv_id=FLASHVAR', 'sohu.com' : 'http://share.vrs.sohu.com/FLASHVAR/v.swf', 'mofile.com' : 'http://tv.mofile.com/cn/xplayer.swf?v=FLASHVAR', 'music' : 'FLASHVAR', 'flash' : 'FLASHVAR' }; var videoFlash = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="430" height="400">' + '<param value="transparent" name="wmode"/>' + '<param value="FLASHADDR" name="movie" />' + '<embed src="FLASHADDR" wmode="transparent" allowfullscreen="true" type="application/x-shockwave-flash" width="430" height="400"></embed>' + '</object>'; var flashHtml = videoFlash; flashvar = encodeURI(flashvar); if(flashAddr[host]) { var flash = flashAddr[host].replace('FLASHVAR', flashvar); flashHtml = flashHtml.replace(/FLASHADDR/g, flash); } return flashHtml; }  var ui={ success:function(message,error){ var s_e_class= (error==1)?"ui_success_box ui_error_box":"ui_success_box"; var html="<div id='ui_box' class='"+s_e_class+"'><div id='ui_messagecontent'>"+message+"</div></div>"; var show=function(){ var bg='<div class="box_bg" style="width: 100%; height:'+jQuery(document).height()+'px; z-index: 998;filter: alpha(opacity=35);-moz-opacity: 0.35;opacity: 0.35;"></div>'; $('body').append(html); $('body').append(bg); var v = ui._viewport() ; $( '#ui_box' ).css({ 'left':( v.left + v.width/2 - $( '#ui_box' ).outerWidth()/2 ) + "px", 'top':( v.top + v.height/2 - $( '#ui_box' ).outerHeight()/2 ) + "px" }); }; var close=function(){ setTimeout( function(){ $( '#ui_box' ).fadeOut("fast",function(){ jQuery('.box_bg').remove(); jQuery('#ui_box').remove(); }); } , 1000); }; show(); close(); },  error:function(message){ ui.success(message,1); },  confirm:function(obj,text){ var callback=$(obj).attr('callback'); text = text || '确定执行此操作？'; this.html = '<div id="qc_ui_confirm" class="ui_confirm">'+ '<a class="del" href="javascript:void(0)" onclick="$(\'#qc_ui_confirm\').remove()"></a>'+ '<div class="txt"></div>'+ '<div class="button"><input type="button" value="确定" class="btn"><input type="button" value="取消" class="btn_w"></div>'+ '</div>'; $('body').append(this.html); var position = $(obj).offset(); $('#qc_ui_confirm').css({"top":position.top+"px","left":position.left-($("#qc_ui_confirm").width()/2)+"px","display":"none"}); $("#qc_ui_confirm .txt").html(text); $('#qc_ui_confirm').fadeIn("fast"); $("#qc_ui_confirm .btn_w").one('click',function(){ $('#qc_ui_confirm').fadeOut("fast"); $('#qc_ui_confirm').remove(); }); $("#qc_ui_confirm .btn").one('click',function(){ $('#qc_ui_confirm').fadeOut("fast"); $('#qc_ui_confirm').remove(); eval(callback); }); }, load:function(title,url,data,inputhtml){ $('.ui_load').remove(); var loading='<div class="ui_loading"></div>'; var html = '<div class="ui_load">'+ '<div class="title"><h3>'+title+'</h3><a class="del" href="javascript:void(0)" onclick="$(\'.ui_load\').remove()"></a></div>'+ '<div class="ui_load_content">'+loading+'</div>'+ '</div>'; $('body').append(html); var v =ui._viewport(); var objBox=$('.ui_load'); objBox.css({'left':( v.left + v.width/2 - objBox.outerWidth()/2 ) + "px",'top':( v.top + v.height/2 - objBox.outerHeight()/2 ) + "px"}); if(inputhtml>0 || inputhtml>''){ $('.ui_load_content').html(inputhtml); objBox.css({ 'left':( v.left + v.width/2 - objBox.outerWidth()/2 ) + "px", 'top':( v.top + v.height/2 - objBox.outerHeight()/2 ) + "px" }); }else{ $.post(url,{data:data},function(txt){ $('.ui_load_content').html(txt); objBox.css({ 'left':( v.left + v.width/2 - objBox.outerWidth()/2 ) + "px", 'top':( v.top + v.height/2 - objBox.outerHeight()/2 ) + "px" }); }); } },  load_close:function(){ $('.ui_load').remove(); }, _viewport: function() { var d = document.documentElement, b = document.body, w = window; return jQuery.extend( jQuery.browser.msie ? { left: b.scrollLeft || d.scrollLeft, top: b.scrollTop || d.scrollTop } : { left: w.pageXOffset, top: w.pageYOffset }, !ui._u(w.innerWidth) ? { width: w.innerWidth, height: w.innerHeight } : (!ui._u(d) && !ui._u(d.clientWidth) && d.clientWidth != 0 ? { width: d.clientWidth, height: d.clientHeight } : { width: b.clientWidth, height: b.clientHeight }) ); }, _u: function() { for (var i = 0; i < arguments.length; i++) if (typeof arguments[i] != 'undefined') return false; return true; },  reload:function(time){ if(time=='' || time==undefined ) time=600; setTimeout('location.reload()',time); } };